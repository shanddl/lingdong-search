name: æ„å»º CRX æ‰©å±•åŒ…

on:
  push:
    # ç›‘å¬mainåˆ†æ”¯çš„ä»£ç å˜æ›´
    branches:
      - main
    # ç›‘å¬tagæ¨é€ï¼ˆç”¨äºåˆ›å»ºReleaseï¼‰
    tags:
      - 'v*'
    # è·¯å¾„è¿‡æ»¤ï¼ˆä»…å¯¹åˆ†æ”¯æ¨é€ç”Ÿæ•ˆï¼Œtagæ¨é€ä¸å—å½±å“ï¼‰
    paths:
      - 'js/**'
      - 'manifest.json'
      - 'package.json'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºRelease
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: è¯»å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(node -p "require('./manifest.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "æ‰©å±•ç‰ˆæœ¬: $VERSION"
      
      - name: ç”Ÿæˆç§é’¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          if [ ! -f "private-key.pem" ]; then
            echo "ğŸ”‘ ç”Ÿæˆç§é’¥æ–‡ä»¶..."
            node -e "
              const NodeRSA = require('node-rsa');
              const fs = require('fs');
              const key = new NodeRSA({ b: 2048 });
              const privateKey = key.exportKey('pkcs1-private-pem');
              fs.writeFileSync('private-key.pem', privateKey);
              console.log('âœ… ç§é’¥ç”ŸæˆæˆåŠŸ');
            "
          else
            echo "âœ… ç§é’¥æ–‡ä»¶å·²å­˜åœ¨"
          fi
      
      - name: æ„å»º CRX æ–‡ä»¶
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º CRX æ–‡ä»¶..."
          npm run build
          
          # å¦‚æœCRXæ„å»ºå¤±è´¥ï¼Œç”ŸæˆZIPä½œä¸ºå¤‡ç”¨
          if [ ! -f *.crx ]; then
            echo "âš ï¸ CRX æ„å»ºå¤±è´¥ï¼Œç”Ÿæˆ ZIP ä½œä¸ºå¤‡ç”¨..."
            npm run package || node scripts/package-extension.js
          fi
      
      - name: åˆ—å‡ºæ„å»ºäº§ç‰©
        run: |
          echo "ğŸ“¦ æŸ¥æ‰¾æ„å»ºäº§ç‰©ï¼š"
          ls -la *.crx 2>/dev/null || echo "æœªæ‰¾åˆ° .crx æ–‡ä»¶"
          ls -la *.zip 2>/dev/null || echo "æœªæ‰¾åˆ° .zip æ–‡ä»¶"
          echo "å½“å‰ç›®å½•æ–‡ä»¶ï¼š"
          ls -la | head -20
      
      - name: å‡†å¤‡Releaseæ–‡ä»¶
        id: release_files
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰æ„å»ºäº§ç‰©
          CRX_FILES=$(find . -maxdepth 1 -name "*.crx" -type f 2>/dev/null | head -1)
          ZIP_FILES=$(find . -maxdepth 1 -name "*.zip" -type f 2>/dev/null | head -1)
          
          if [ -n "$CRX_FILES" ]; then
            echo "found_crx=$CRX_FILES" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°CRXæ–‡ä»¶: $CRX_FILES"
          else
            echo "found_crx=" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°CRXæ–‡ä»¶"
          fi
          
          if [ -n "$ZIP_FILES" ]; then
            echo "found_zip=$ZIP_FILES" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°ZIPæ–‡ä»¶: $ZIP_FILES"
          else
            echo "found_zip=" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°ZIPæ–‡ä»¶"
          fi
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: extension-package
          path: |
            *.crx
            *.zip
          retention-days: 30
      
      - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ›å»º Release
        id: check_release
        run: |
          # å¦‚æœæ¨é€äº†tagï¼Œæˆ–è€…æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™åˆ›å»ºRelease
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_create=true" >> $GITHUB_OUTPUT
            echo "è§¦å‘æ–¹å¼: æ‰‹åŠ¨è§¦å‘"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "should_create=true" >> $GITHUB_OUTPUT
            echo "è§¦å‘æ–¹å¼: Tagæ¨é€ - ${{ github.ref }}"
            # ä»tagä¸­æå–ç‰ˆæœ¬å·
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          else
            # æ£€æŸ¥æœ¬æ¬¡æäº¤æ˜¯å¦ä¿®æ”¹äº†manifest.json
            if git diff --name-only HEAD~1 HEAD | grep -q "manifest.json"; then
              echo "should_create=true" >> $GITHUB_OUTPUT
              echo "è§¦å‘æ–¹å¼: manifest.jsonç‰ˆæœ¬å˜æ›´"
            else
              echo "should_create=false" >> $GITHUB_OUTPUT
              echo "è·³è¿‡Releaseåˆ›å»ºï¼ˆä»…ä»£ç æ›´æ–°ï¼Œæ— ç‰ˆæœ¬å˜æ›´ï¼‰"
            fi
          fi
      
      - name: åˆ›å»ºæˆ–æ›´æ–° Release
        if: steps.check_release.outputs.should_create == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.release_files.outputs.found_crx }}
            ${{ steps.release_files.outputs.found_zip }}
          tag_name: ${{ steps.check_release.outputs.tag_name || format('v{0}', steps.version.outputs.version) }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## ç‰ˆæœ¬ v${{ steps.version.outputs.version }}
            
            ### æ„å»ºä¿¡æ¯
            - **æ„å»ºæ—¶é—´**: ${{ github.run_started_at }}
            - **æäº¤**: ${{ github.sha }}
            - **æäº¤æ¶ˆæ¯**: ${{ github.event.head_commit.message || github.event.pusher.name }}
            
            ### ä¸‹è½½è¯´æ˜
            è¯·ä¸‹è½½å¯¹åº”çš„æ‰©å±•åŒ…æ–‡ä»¶ï¼ˆ.crx æˆ– .zipï¼‰å¹¶å®‰è£…åˆ° Chrome æµè§ˆå™¨ä¸­ã€‚
            
            **å®‰è£…æ–¹æ³•**ï¼š
            1. ä¸‹è½½ `.crx` æ–‡ä»¶ï¼ˆå¦‚æœç”ŸæˆæˆåŠŸï¼‰
            2. æˆ–è€…ä¸‹è½½ `.zip` æ–‡ä»¶å¹¶è§£å‹
            3. æ‰“å¼€ Chromeï¼Œè¿›å…¥ `chrome://extensions/`
            4. å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false  # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ä¹Ÿä¸å¤±è´¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
